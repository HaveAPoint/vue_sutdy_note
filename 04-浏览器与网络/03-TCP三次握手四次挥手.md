# TCP 三次握手与四次挥手

## 为什么要"握手"？
TCP 是**可靠的、面向连接**的传输层协议。
就像打电话：
- "喂，听得到吗？"
- "听得到，你呢？"
- "我也听得到。"
确保双方的发送和接收能力皆正常。

---

## 三次握手 (建立连接)

### 流程图解

```
Client (客户端)                     Server (服务端)
  |                                     |
  | 1. SYN=1, seq=x                     | (LISTEN)
  |------------------------------------>|
  | (SYN_SENT)                          | 2. SYN=1, ACK=1, seq=y, ack=x+1
  |                                     | (SYN_RCVD)
  |<------------------------------------|
  | 3. ACK=1, seq=x+1, ack=y+1          |
  |------------------------------------>|
  | (ESTABLISHED)                       | (ESTABLISHED)
```

### 通俗解释

1. **第一次**：客户端发包。"喂，我想连你。"
   - 证明：客户端发送能力正常。
2. **第二次**：服务端收到，回复。"好的，我收到了，我也想连你。"
   - 证明：服务端接收、发送能力正常。
3. **第三次**：客户端收到回复，确认。"收到你的回复了，连接建立。"
   - 证明：客户端接收能力正常，服务端知道自己发送被收到了。

### 为什么是 3 次不是 2 次？
**防止失效的连接请求突然传到服务端**。
如果只有 2 次：客户端发了请求 A（在网络滞留），又发了请求 B（连接成功并结束后断开）。此时请求 A 终于到了，服务端以为是新请求，建立连接并等待，浪费资源。有第 3 次确认，客户端会说"我没要连啊"，服务器就知道不用等了。

---

## 四次挥手 (断开连接)

TCP 是全双工的（双方都能随时发数据），所以断开要双方都同意。

### 流程图解

```
Client                              Server
  | 1. FIN=1, seq=u                     |
  |------------------------------------>|
  | (FIN_WAIT_1)                        | 2. ACK=1, seq=v, ack=u+1
  |                                     | (CLOSE_WAIT)
  |<------------------------------------|
  | (FIN_WAIT_2)                        |
  |                                     | ... 服务端把剩余数据发完 ...
  |                                     |
  |                                     | 3. FIN=1, ACK=1, seq=w, ack=u+1
  |                                     | (LAST_ACK)
  |<------------------------------------|
  | 4. ACK=1, seq=u+1, ack=w+1          |
  |------------------------------------>|
  | (TIME_WAIT) --> 等待 2MSL           | (CLOSED)
```

### 通俗解释

1. **第一次**（Client -> Server）："我的数据发完了，我要挂了。" (Client 停止发送数据)
2. **第二次**（Server -> Client）："知道了。" (但 Server 可能还有数据没发完，Client 还能接收)
   - 此态为半关闭状态。
3. **第三次**（Server -> Client）："我也发完了，我也要挂了。" (Server 停止发送数据)
4. **第四次**（Client -> Server）："好的，拜拜。" (连接断开)

### 为什么是 4 次？
因为 Server 收到 FIN 报文时，可能还有数据要发，不能立马发 FIN 结束与之断开，所以先回一个 ACK 确认收到，等自己把数据发完了，再发 FIN。所以把 2、3 步分开了。

### 为什么 Client 要等待 2MSL？
确保第 4 次发送的 ACK 报文能到达 Server。如果 Server 没收到，会重发 FIN，Client 就能在等待期内收到重发的 FIN 并重新确认。
