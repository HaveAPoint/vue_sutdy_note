# 执行上下文（Execution Context）

## 概念

代码运行时的环境抽象，包括作用域链、变量、this 等。分为：
- **全局执行上下文**：页面加载后创建，只有一个。
- **函数执行上下文**：每次调用函数都会创建新的。
- **Eval 执行上下文**：通常不使用。

所有上下文按顺序压入**调用栈**（LIFO）。栈顶是当前正在执行的上下文。

## 创建阶段 vs 执行阶段

1. **创建阶段（编译）**
   - 确定 `this` 绑定：非严格模式下全局为 `window`，严格模式为 `undefined`；函数调用取决于调用方式。
   - 建立词法环境（Lexical Environment）：记录 `let/const`、函数声明、外层作用域引用（作用域链）。
   - 建立变量环境（Variable Environment）：记录 `var` 声明（变量提升，初始值 `undefined`）。
   - 生成作用域链：当前词法环境 → 外层引用 → ... → 全局。
2. **执行阶段**
   - 逐行运行代码，给变量赋值、执行函数等。

## 作用域与 this

- **作用域**由词法环境决定（函数定义时固定），与调用位置无关。
- **this** 由调用方式决定：
  - 普通调用：非严格模式为全局对象，严格模式为 `undefined`
  - `obj.fn()`：指向 `obj`
  - `call/apply/bind`：显式指定
  - `new Fn()`：指向新实例
  - 箭头函数：无自己的 this，继承外层词法作用域的 this

## 常见考点

- **变量提升**：`var` 提升到上下文顶部赋值 `undefined`；`let/const` 存在暂时性死区，使用前会报错。
- **嵌套函数**：内层函数的作用域链包含外层词法环境，因此能形成闭包。
- **尾调用优化**：需要严格模式 + 返回函数调用，部分环境优化调用栈。
- **异步回调**：事件循环决定回调何时入栈执行，上下文出栈后，闭包变量仍由词法环境持有。
