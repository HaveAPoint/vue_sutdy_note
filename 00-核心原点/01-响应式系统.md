# Vue 核心原点一：响应式系统 (Reactivity)

## 本质

响应式是 Vue 最核心的机制。它解决的问题是：

**当数据变化时，自动更新依赖这个数据的 DOM。**

你不需要手动操作 DOM，只需要修改数据。

## 原理

```javascript
// Vue 3 使用 Proxy 实现
const state = reactive({ count: 0 })

// 当你读取 state.count 时，Vue 记录"谁在读"
// 当你修改 state.count 时，Vue 通知所有"读过的人"更新
```

### Vue 2 vs Vue 3 实现差异

| 版本 | 实现方式 | 局限性 |
|------|----------|--------|
| Vue 2 | `Object.defineProperty` | 无法检测属性新增/删除，数组索引修改不响应 |
| Vue 3 | `Proxy` | 完整拦截，无上述限制 |

## 核心 API

### `ref` - 包装基本类型

```javascript
import { ref } from 'vue'

const count = ref(0)
console.log(count.value) // 0
count.value++            // 触发更新
```

**为什么需要 `.value`？**

JavaScript 基本类型是值传递，无法被 Proxy 拦截。`ref` 把它包装成对象 `{ value: 0 }`，这样才能追踪。

### `reactive` - 包装对象

```javascript
import { reactive } from 'vue'

const state = reactive({
  user: { name: 'Tom' },
  items: []
})

state.user.name = 'Jerry'  // 响应式
state.items.push('item')   // 响应式
```

### `ref` vs `reactive` 选择结论

| | `ref` | `reactive` |
|---|---|---|
| 基本类型 | 能用 | 不能用 |
| 对象 | 能用 | 能用 |
| 可替换整体 | 能 | 不能 |
| 解构安全 | 是 | 否 |

**结论：优先使用 `ref`。** 它能覆盖所有场景，心智负担更小。`.value` 看起来麻烦，但它明确标识"这是响应式数据"，反而是优点。

### `computed` - 派生状态

```javascript
import { ref, computed } from 'vue'

const price = ref(100)
const quantity = ref(2)

// 自动追踪依赖，price 或 quantity 变化时自动重算,
// computed ≈ 带自动缓存的 getter + 观察者模式
const total = computed(() => price.value * quantity.value)
```

## 常见陷阱

### 1. 解构丢失响应性

```javascript
const state = reactive({ count: 0 })

// 错误：解构后 count 只是普通变量，失去响应性
const { count } = state

// 正确：使用 toRefs
const { count } = toRefs(state)
```

### 2. 替换整个 reactive 对象

```javascript
let state = reactive({ count: 0 })

// 错误：替换引用，原来的响应式连接断开
state = reactive({ count: 1 })

// 正确：修改属性
state.count = 1
```

### 3. ref 在模板中自动解包

```javascript
// 在 <script> 中需要 .value
count.value++

// 在 <template> 中自动解包，不需要 .value
<div>{{ count }}</div>
```

## 后端类比

如果你熟悉后端概念：

- **响应式 ≈ 观察者模式**：数据是 Subject，组件是 Observer
- **computed ≈ 数据库视图**：基于源数据自动派生，源数据变则视图变
- **依赖收集 ≈ 依赖注入的自动化版本**：框架自动分析谁依赖谁

## 深入阅读

- [Vue 官方文档 - 深入响应式系统](https://cn.vuejs.org/guide/extras/reactivity-in-depth.html)
- 尝试手写一个 50 行的极简响应式系统，加深理解
